#!/bin/bash


# https://github.com/adoptium/temurin8-binaries/releases/download/jdk8u472-b08/OpenJDK8U-jdk_x64_linux_hotspot_8u472b08.tar.gz

# 模组服
## Fabric
## Forge
## NeoForge

# 插件服
## purpur
## paper

# adoptium
## JDK 25 - LTS
## JDK 21 - LTS
## JDK 17 - LTS
## JDK 11 - LTS
## JDK 8 - LTS

# 全局变量
ROOT_DIR="$HOME/MCST"
SERVER_DIR="$ROOT_DIR/Servers"
JDK_DIR="$ROOT_DIR/JDKs"
ARCH=$(uname -m)

# 颜色定义
setup_colors() {
    NC='\033[0m'
    RED='\033[1;31m'
    GREEN='\033[1;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[1;34m'
    PURPLE='\033[1;35m'
    CYAN='\033[1;96m'
    
    red_bg='\033[41m'
    blue_bg='\033[44m'
    yellow_bg='\033[43m'
    
    blue_fg_strong='\033[1;94m'
    yellow_fg_strong='\033[1;93m'
    red_fg_strong='\033[1;91m'
}

log() {
    local current_time=$(date +'%H:%M:%S')
    case "$1" in
        "INFO")  echo -e "${blue_bg}[$current_time]${NC} ${blue_fg_strong}[信息]${NC} $2" ;;
        "WARN")  echo -e "${yellow_bg}[$current_time]${NC} ${yellow_fg_strong}[警告]${NC} $2" ;;
        "ERROR") echo -e "${red_bg}[$current_time]${NC} ${red_fg_strong}[错误]${NC} $2" ;;
        *)       echo -e "${blue_bg}[$current_time]${NC} ${blue_fg_strong}[调试]${NC} $2" ;;
    esac
}

check_arch() {
    if [[ "$ARCH" != "aarch64" && "$ARCH" != "x86_64" ]]; then
        echo "不支持的架构: $ARCH (仅支持 aarch64 和 x86_64)"
        exit 1
    fi
}



# 获取下载链接的函数
get_adoptium_url() {
    local ADOPTIUM_BASE="https://github.com/adoptium"
    local ver=$1
    local arch_tag=""
    
    # 转换架构标识
    [[ "$ARCH" == "aarch64" ]] && arch_tag="aarch64"
    [[ "$ARCH" == "x86_64" ]] && arch_tag="x64"

    case "$ver" in
        "25")
            local release_tag="jdk-25.0.2+10"
            local file_ver="25.0.2_10"
            local filename="OpenJDK25U-jdk_${arch_tag}_linux_hotspot_${file_ver}.tar.gz"
            echo "${ADOPTIUM_BASE}/temurin25-binaries/releases/download/${release_tag}/${filename}"
            ;;
        "21")
            local release_tag="jdk-21.0.10+7"
            local file_ver="21.0.10_7"

            local filename="OpenJDK21U-jdk_${arch_tag}_linux_hotspot_${file_ver}.tar.gz"
            echo "${ADOPTIUM_BASE}/temurin21-binaries/releases/download/${release_tag}/${filename}"
            ;;
        "17")
            local release_tag="jdk-17.0.18+8"
            local file_ver="17.0.18_8"
            local filename="OpenJDK17U-jdk_${arch_tag}_linux_hotspot_${file_ver}.tar.gz"
            echo "${ADOPTIUM_BASE}/temurin17-binaries/releases/download/${release_tag}/${filename}"
            ;;
        "11")
            local release_tag="jdk-11.0.29+7"
            local file_ver="11.0.29_7"
            local filename="OpenJDK11U-jdk_${arch_tag}_linux_hotspot_${file_ver}.tar.gz"
            echo "${ADOPTIUM_BASE}/temurin11-binaries/releases/download/${release_tag}/${filename}"
            ;;
        "8")
            local release_tag="jdk8u472-b08"
            local file_ver="8u472b08"
            local filename="OpenJDK8U-jdk_${arch_tag}_linux_hotspot_${file_ver}.tar.gz"
            echo "${ADOPTIUM_BASE}/temurin8-binaries/releases/download/${release_tag}/${filename}"
            ;;
        *)
            return 1
            ;;
    esac
}

# 执行安装的逻辑
install_jdk() {
    local ver=$1
    local download_url=$(get_adoptium_url "$ver")
    
    if [[ -z "$download_url" ]]; then
        log "ERROR" "未配置 JDK $ver 的下载地址"
        return
    fi

    log "INFO" "正在获取 JDK $ver ($ARCH)..."
    log "INFO" "链接: $download_url"
    
    # 这里可以接具体的下载和解压逻辑
    # mkdir -p "$JDK_DIR/jdk$ver"
    # curl -L "$download_url" | tar -xz -C "$JDK_DIR/jdk$ver" --strip-components=1
}



show_banner() {
    clear
    local R='\033[1;31m'
    local Y='\033[1;33m'
    local G='\033[1;32m'
    local C='\033[1;36m'
    local B='\033[1;34m'
    local P='\033[1;35m'
    local NC='\033[0m'

    echo -e "    ${R}███╗   ███╗ ${Y}██████╗ ${G}███████╗${C}████████╗"
    echo -e "    ${R}████╗ ████║${Y}██╔════╝ ${G}██╔════╝${C}╚══██╔══╝"
    echo -e "    ${R}██╔████╔██║${Y}██║      ${G}███████╗${C}   ██║   "
    echo -e "    ${R}██║╚██╔╝██║${Y}██║      ${G}╚════██║${C}   ██║   "
    echo -e "    ${R}██║ ╚═╝ ██║${Y}╚██████╗ ${G}███████║${C}   ██║   "
    echo -e "    ${R}╚═╝     ╚═╝ ${Y}╚═════╝ ${G}╚══════╝${C}   ╚═╝   "
    echo -e "    ${P}      Minecraft Server Tool${NC}\n"
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BLUE}当前位置: ${YELLOW}${STEP_PATH:-主菜单}${NC}"
    echo -e "${BLUE}架构信息: ${PURPLE}$ARCH${NC}"
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
}

menu_selector() {
    local title=$1
    local default_idx=$2
    local is_main=$3
    shift 3
    local options=("$@")
    local exit_label=$([[ "$is_main" == "true" ]] && echo "退出脚本" || echo "返回上一级")

    show_banner
    echo -e "${PURPLE}>> $title${NC}"
    for i in "${!options[@]}"; do
        local idx=$((i+1))
        local suffix=""
        # 拆分逻辑，提高兼容性
        if [[ $idx -eq $default_idx ]]; then
            suffix=" ${CYAN}(默认)${NC}"
        fi
        echo -e "${GREEN}$idx)${NC} ${options[$i]}$suffix"
    done
    echo -e "---------------------------------------------"
    echo -e "${RED}0)${NC} $exit_label"
    
    read -p "请输入选项 [回车默认 $default_idx]: " input
    [[ -z "$input" ]] && return "$default_idx"
    [[ "$input" =~ ^[0-9]+$ ]] && [ "$input" -le "${#options[@]}" ] && return "$input"
    return 255
}

main() {
    setup_colors
    check_arch
    
    local step="MAIN"
    while true; do
        case $step in
            "MAIN")
                STEP_PATH="主菜单"
                local main_list=("服务器管理" "JDK 安装" "更新脚本" "关于脚本")
                menu_selector "请选择操作" 1 "true" "${main_list[@]}"
                case $? in
                    0) exit 0 ;;
                    1) step="SERVER_TYPE" ;;
                    2) step="JDK_VENDOR" ;;
                    3) log "INFO" "功能开发中..."; sleep 1 ;;
                    4) log "INFO" "By 东经雨"; sleep 2 ;;
                    *) log "ERROR" "无效输入" ;;
                esac
                ;;
            "SERVER_TYPE")
                STEP_PATH="主菜单 > 服务器"
                local type_list=("模组服 (Fabric/Forge)" "插件服 (Purpur/Paper)")
                menu_selector "选择服务器类型" 1 "false" "${type_list[@]}"
                case $? in
                    0) step="MAIN" ;;
                    1) step="SERVER_MOD" ;;
                    2) step="SERVER_PLUGIN" ;;
                esac
                ;;
            "SERVER_MOD")
                STEP_PATH="主菜单 > 服务器 > 模组服"
                local mod_list=("Fabric" "Forge" "NeoForge")
                menu_selector "选择模组核心" 1 "false" "${mod_list[@]}"
                local res=$?
                if [[ $res -eq 0 ]]; then step="SERVER_TYPE"; else
                    log "INFO" "已选择模组核心: ${mod_list[$((res-1))]}"
                    sleep 1
                fi
                ;;
            "SERVER_PLUGIN")
                STEP_PATH="主菜单 > 服务器 > 插件服"
                local plugin_list=("Purpur" "Paper")
                menu_selector "选择插件核心" 1 "false" "${plugin_list[@]}"
                local res=$?
                if [[ $res -eq 0 ]]; then step="SERVER_TYPE"; else
                    log "INFO" "已选择插件核心: ${plugin_list[$((res-1))]}"
                    sleep 1
                fi
                ;;
            "JDK_VENDOR")
                STEP_PATH="主菜单 > JDK"
                local vendor_list=("Adoptium (Temurin)")
                menu_selector "选择 JDK 厂商" 1 "false" "${vendor_list[@]}"
                case $? in
                    0) step="MAIN" ;;
                    1) step="JDK_VER_ADOPTIUM" ;;
                esac
                ;;
            "JDK_VER_ADOPTIUM")
                STEP_PATH="主菜单 > JDK > Adoptium"
                local jdk_list=("JDK 25 (LTS)" "JDK 21 (LTS)" "JDK 17 (LTS)" "JDK 11 (LTS)" "JDK 8 (LTS)")
                menu_selector "选择版本" 1 "false" "${jdk_list[@]}"
                local res=$?
                if [[ $res -eq 0 ]]; then 
                    step="JDK_VENDOR"
                else
                    # 提取数字，如 25, 21, 8
                    local ver=$(echo "${jdk_list[$((res-1))]}" | sed 's/[^0-9]//g')
                    install_jdk "$ver"
                    sleep 2
                fi
                ;;
        esac
    done
}

main "$@"