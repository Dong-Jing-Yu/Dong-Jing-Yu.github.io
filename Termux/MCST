#!/bin/bash

# 全局变量

ROOT_DIR="$HOME/.MCST"
SERVER_DIR="$ROOT_DIR/Servers"
JDK_DIR="$ROOT_DIR/JDKs"
ARCH=$(uname -m)

init_lock=false
init_VERSION="0.0.1"
LOCK_FILE="$ROOT_DIR/init_lock"

log() {
    local current_time=$(date +'%H:%M:%S')
    case "$1" in
        "INFO")  echo -e "${blue_bg}[$current_time]${NC} ${blue_fg_strong}[信息]${NC} $2" ;;
        "WARN")  echo -e "${yellow_bg}[$current_time]${NC} ${yellow_fg_strong}[警告]${NC} $2" ;;
        "ERROR") echo -e "${red_bg}[$current_time]${NC} ${red_fg_strong}[错误]${NC} $2" ;;
        *)       echo -e "${blue_bg}[$current_time]${NC} ${blue_fg_strong}[调试]${NC} $2" ;;
    esac
}

check_arch() {
    if [[ "$ARCH" != "aarch64"]]; then
        log "ERROR" "不支持的架构: $ARCH (仅支持 aarch64 )"
        exit 1
    fi
}

_init() {
    log "INFO" "执行初始化流程..."
    for dir in "$ROOT_DIR" "$SERVER_DIR" "$JDK_DIR"; do
        if [ ! -d "$dir" ]; then
            mkdir -p "$dir"
            log "INFO" "创建目录: $dir"
        fi
    done


    log "INFO" "检查并安装依赖包..."
    
    # 备份原始 sources.list
    if [ ! -f "$PREFIX/etc/apt/sources.list.bak" ]; then
        cp "$PREFIX/etc/apt/sources.list" "$PREFIX/etc/apt/sources.list.bak"
    fi
    
    # 更新源到清华镜像
    if ! grep -q "mirrors.tuna.tsinghua.edu.cn" "$PREFIX/etc/apt/sources.list"; then
        log "INFO" "更新软件源到清华镜像..."
        sed -i 's@^\(deb.*stable main\)$@#\1\ndeb https://mirrors.tuna.tsinghua.edu.cn/termux/apt/termux-main stable main@' $PREFIX/etc/apt/sources.list
    fi
    
    # 更新包索引
    log "INFO" "更新包索引..."
    apt update && apt upgrade -y -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold"

    local required_packages=("curl" "tar" "wget" "unzip" "git" "libandroid-shmem" "libandroid-spawn" "freetype")
    local missing_packages=()
    
    # 检查缺失的包
    for package in "${required_packages[@]}"; do
        if ! command_exists "$package"; then
            missing_packages+=("$package")
        else
            log "INFO" "$package 已就绪"
        fi
    done

    # 安装缺失的包
    if [ ${#missing_packages[@]} -gt 0 ]; then
        log "INFO" "安装缺失的包: ${missing_packages[*]}"
        for package in "${missing_packages[@]}"; do
            log "INFO" "正在安装 $package..."
            apt install -y "$package" || { log "WARN" "重新尝试安装 $package"; apt install -y "$package" || log "ERROR" "无法安装 $package"; }
        done
    fi


    echo "$init_VERSION" > "$LOCK_FILE"
    log "INFO" "初始化完成，版本 $init_VERSION"
    init_lock=true
}


check_init() {
    log "INFO" "初始化检查..."
    check_arch
    if [ ! -f "$LOCK_FILE" ];then
        _init
    else
        local stored_version=$(cat "$LOCK_FILE" 2>/dev/null)
        if [ "$stored_version" != "$init_VERSION" ]; then
            log "WARN" "检测到版本不匹配,当前版本: $init_VERSION 锁文件中版本: $stored_version"
            _init
        else
            init_lock=true
            log "INFO" "初始化已完成，版本匹配: $init_VERSION"
        fi
    fi
    sleep 1
}

download_file() {
    local url="$1"
    local dest="$2"

    if [[ "$url" == https://github.com/* ]]; then
        url="https://gh-proxy.org/$url"
        log "INFO" "使用 GitHub 镜像"
    fi

    log "INFO" "下载文件: $url"
    wget -q --show-progress -O "$dest" "$url"
    if [ $? -ne 0 ]; then
        log "ERROR" "下载失败: $url"
        return 1
    fi
    log "INFO" "下载完成: $dest"
    return 0
}



# 获取下载链接的函数
get_jdk() {
    local ver=$1
    case "$ver" in
        "25")
            install_jdk 25
            ;;
        "21")
            install_jdk 21
            ;;
        "17")
            install_jdk 17
            ;;
        "11")
            install_jdk 11
            ;;
        "8")
            install_jdk 8
            ;;
        *)
            return 1
            ;;
    esac
}

install_jdk() {
    local URL="https://github.com/Dong-Jing-Yu/Dong-Jing-Yu.github.io/releases/download/jdk"
    local tag=$1

    log "INFO" "正在安装 JDK $tag..."

    download_file "$URL"/jdk"$tag".tar.gz "$JDK_DIR/$tag.tar.gz"

    tar -xzf "$JDK_DIR/$tag.tar.gz" -C "$JDK_DIR"
    mv "$JDK_DIR/java-$tag-openjdk/" "$JDK_DIR/JDK$tag/"

    rm "$JDK_DIR/$tag.tar.gz"
    log "INFO" "JDK $tag 安装完成"
}


show_banner() {
    clear
    local R='\033[1;31m'
    local Y='\033[1;33m'
    local G='\033[1;32m'
    local C='\033[1;36m'
    local B='\033[1;34m'
    local P='\033[1;35m'
    local NC='\033[0m'

    echo -e "    ${R}███╗   ███╗ ${Y}██████╗ ${G}███████╗${C}████████╗"
    echo -e "    ${R}████╗ ████║${Y}██╔════╝ ${G}██╔════╝${C}╚══██╔══╝"
    echo -e "    ${R}██╔████╔██║${Y}██║      ${G}███████╗${C}   ██║   "
    echo -e "    ${R}██║╚██╔╝██║${Y}██║      ${G}╚════██║${C}   ██║   "
    echo -e "    ${R}██║ ╚═╝ ██║${Y}╚██████╗ ${G}███████║${C}   ██║   "
    echo -e "    ${R}╚═╝     ╚═╝ ${Y}╚═════╝ ${G}╚══════╝${C}   ╚═╝   "
    echo -e "    ${P}      Minecraft Server Tool${NC}\n"
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BLUE}当前位置: ${YELLOW}${STEP_PATH:-主菜单}${NC}"
    echo -e "${BLUE}架构信息: ${PURPLE}$ARCH${NC}"
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
}

menu_selector() {
    local title=$1
    local default_idx=$2
    local is_main=$3
    shift 3
    local options=("$@")
    local exit_label=$([[ "$is_main" == "true" ]] && echo "退出脚本" || echo "返回上一级")

    show_banner
    echo -e "${PURPLE}>> $title${NC}"
    for i in "${!options[@]}"; do
        local idx=$((i+1))
        local suffix=""
        # 拆分逻辑，提高兼容性
        if [[ $idx -eq $default_idx ]]; then
            suffix=" ${CYAN}(默认)${NC}"
        fi
        echo -e "${GREEN}$idx)${NC} ${options[$i]}$suffix"
    done
    echo -e "---------------------------------------------"
    echo -e "${RED}0)${NC} $exit_label"
    
    read -p "请输入选项 [回车默认 $default_idx]: " input
    [[ -z "$input" ]] && return "$default_idx"
    [[ "$input" =~ ^[0-9]+$ ]] && [ "$input" -le "${#options[@]}" ] && return "$input"
    return 255
}

main() {
    # 颜色定义    
    NC='\033[0m'
    RED='\033[1;31m'
    GREEN='\033[1;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[1;34m'
    PURPLE='\033[1;35m'
    CYAN='\033[1;96m'
    
    red_bg='\033[41m'
    blue_bg='\033[44m'
    yellow_bg='\033[43m'
    
    blue_fg_strong='\033[1;94m'
    yellow_fg_strong='\033[1;93m'
    red_fg_strong='\033[1;91m'
    check_init
    
    local step="MAIN"
    while true; do
        case $step in
            "MAIN")
                STEP_PATH="主菜单"
                local main_list=("服务器管理" "JDK 安装" "更新脚本" "关于脚本")
                menu_selector "请选择操作" 1 "true" "${main_list[@]}"
                case $? in
                    0) exit 0 ;;
                    1) step="SERVER_TYPE" ;;
                    2) step="JDK_VENDOR" ;;
                    3) log "INFO" "功能开发中..."; sleep 1 ;;
                    4) log "INFO" "By 东经雨"; sleep 2 ;;
                    *) log "ERROR" "无效输入" ;;
                esac
                ;;
            "SERVER_TYPE")
                STEP_PATH="主菜单 > 服务器"
                local type_list=("模组服 (Fabric/Forge)" "插件服 (Purpur/Paper)")
                menu_selector "选择服务器类型" 1 "false" "${type_list[@]}"
                case $? in
                    0) step="MAIN" ;;
                    1) step="SERVER_MOD" ;;
                    2) step="SERVER_PLUGIN" ;;
                esac
                ;;
            "SERVER_MOD")
                STEP_PATH="主菜单 > 服务器 > 模组服"
                local mod_list=("Fabric" "Forge" "NeoForge")
                menu_selector "选择模组核心" 1 "false" "${mod_list[@]}"
                local res=$?
                if [[ $res -eq 0 ]]; then step="SERVER_TYPE"; else
                    log "INFO" "已选择模组核心: ${mod_list[$((res-1))]}"
                    sleep 1
                fi
                ;;
            "SERVER_PLUGIN")
                STEP_PATH="主菜单 > 服务器 > 插件服"
                local plugin_list=("Purpur" "Paper")
                menu_selector "选择插件核心" 1 "false" "${plugin_list[@]}"
                local res=$?
                if [[ $res -eq 0 ]]; then step="SERVER_TYPE"; else
                    log "INFO" "已选择插件核心: ${plugin_list[$((res-1))]}"
                    sleep 1
                fi
                ;;
            "JDK_VENDOR")
                STEP_PATH="主菜单 > JDK"
                local jdk_list=("JDK 25 (LTS)" "JDK 21 (LTS)" "JDK 17 (LTS)" "JDK 11 (LTS)" "JDK 8 (LTS)")
                menu_selector "选择版本" 1 "false" "${jdk_list[@]}"
                local res=$?
                if [[ $res -eq 0 ]]; then 
                    step="MAIN"
                else
                    # 提取数字，如 25, 21, 8
                    local ver=$(echo "${jdk_list[$((res-1))]}" | sed 's/[^0-9]//g')
                    get_jdk "$ver"
                    sleep 2
                fi
                ;;
                *)
                step="MAIN"
                ;;
        esac
    done
}

main "$@"